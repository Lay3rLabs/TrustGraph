version: '3'

silent: true

tasks:
  build:
    desc: 'Build the WAVS WASI component'
    vars:
      NAME:
        sh: cargo read-manifest 2>/dev/null | jq -r '.name'
      OUTPUT_DIR:
        sh: dir='{{.OUTPUT_DIR | default "../../compiled"}}' && mkdir -p "$dir" && realpath "$dir"
      TARGET_DIR: '{{.TARGET_DIR | default "../../target/wasm32-wasip1/release"}}'
      TARGET_FILE_NAME:
        # replace hyphens with underscores
        sh: echo $(echo {{.NAME}} | tr - _).wasm
    cmds:
      - |
        echo "üõ†Ô∏è  Building component: {{.NAME}}"
        cargo component build --release; cargo fmt
        mkdir -p {{.OUTPUT_DIR}}
        cp {{.TARGET_DIR}}/{{.TARGET_FILE_NAME}} {{.OUTPUT_DIR}}
        echo "‚úÖ Component built and copied to: {{.OUTPUT_DIR}}/{{.TARGET_FILE_NAME}}"
